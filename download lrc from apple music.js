// ==UserScript==
// @name        download lrc from apple music
// @namespace   https://github.com/nagisa2086/lrc_download
// @include     https://music.apple.com/*/album/*
// @grant       none
// @version     1.0
// @author      nagisa
// @description 2024/8/23 21:06:45
// ==/UserScript==
const btn=window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x63\x72\x65\x61\x74\x65\x45\x6c\x65\x6d\x65\x6e\x74']('\x62\x75\x74\x74\x6f\x6e');btn['\x73\x74\x79\x6c\x65']['\x70\x6f\x73\x69\x74\x69\x6f\x6e']='\x66\x69\x78\x65\x64';btn['\x73\x74\x79\x6c\x65']['\x72\x69\x67\x68\x74']='\x31\x30\x70\x78';btn['\x73\x74\x79\x6c\x65']['\x74\x6f\x70']='\x35\x30\x25';btn['\x73\x74\x79\x6c\x65']['\x74\x72\x61\x6e\x73\x66\x6f\x72\x6d']='\x74\x72\x61\x6e\x73\x6c\x61\x74\x65\x59\x28\x2d\x35\x30\x25\x29';btn['\x73\x74\x79\x6c\x65']['\x77\x69\x64\x74\x68']='\x35\x30\x70\x78';btn['\x73\x74\x79\x6c\x65']['\x68\x65\x69\x67\x68\x74']='\x35\x30\x70\x78';btn['\x73\x74\x79\x6c\x65']['\x62\x6f\x72\x64\x65\x72\x52\x61\x64\x69\x75\x73']='\x35\x30\x25';btn['\x73\x74\x79\x6c\x65']['\x62\x61\x63\x6b\x67\x72\x6f\x75\x6e\x64\x43\x6f\x6c\x6f\x72']='\x23\x31\x32\x39\x36\x44\x42';btn['\x73\x74\x79\x6c\x65']['\x62\x6f\x72\x64\x65\x72']='\x6e\x6f\x6e\x65';btn['\x73\x74\x79\x6c\x65']['\x63\x75\x72\x73\x6f\x72']='\x70\x6f\x69\x6e\x74\x65\x72';btn['\x73\x74\x79\x6c\x65']['\x64\x69\x73\x70\x6c\x61\x79']='\x66\x6c\x65\x78';btn['\x73\x74\x79\x6c\x65']['\x61\x6c\x69\x67\x6e\x49\x74\x65\x6d\x73']='\x63\x65\x6e\x74\x65\x72';btn['\x73\x74\x79\x6c\x65']['\x6a\x75\x73\x74\x69\x66\x79\x43\x6f\x6e\x74\x65\x6e\x74']='\x63\x65\x6e\x74\x65\x72';btn['\x73\x74\x79\x6c\x65']['\x7a\x49\x6e\x64\x65\x78']='\x39\x39\x39\x39';btn['\x73\x74\x79\x6c\x65']['\x63\x6f\x6c\x6f\x72']='\x23\x46\x46\x46\x46\x46\x46';const icon=window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x63\x72\x65\x61\x74\x65\x45\x6c\x65\x6d\x65\x6e\x74']('\x73\x70\x61\x6e');icon['\x73\x74\x79\x6c\x65']['\x66\x6f\x6e\x74\x53\x69\x7a\x65']='\x31\x36\x70\x78';icon['\x69\x6e\x6e\x65\x72\x48\x54\x4d\x4c']='\u6b4c\u8bcd';btn['\x61\x70\x70\x65\x6e\x64\x43\x68\x69\x6c\x64'](icon);var m1=window['\x6c\x6f\x63\x61\x74\x69\x6f\x6e']['\x68\x72\x65\x66'];let regionCode="";let lang="";let devToken="";let mnt="";btn['\x6f\x6e\x63\x6c\x69\x63\x6b']=function(){const urlObj=new URL(m1);const pathParts=urlObj['\x70\x61\x74\x68\x6e\x61\x6d\x65']['\x73\x70\x6c\x69\x74']('\x2f');regionCode=pathParts[1];lang=window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x64\x6f\x63\x75\x6d\x65\x6e\x74\x45\x6c\x65\x6d\x65\x6e\x74']['\x6c\x61\x6e\x67'];const aid=window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72']('\x6d\x65\x74\x61\x5b\x6e\x61\x6d\x65\x3d\x22\x61\x70\x70\x6c\x65\x3a\x63\x6f\x6e\x74\x65\x6e\x74\x5f\x69\x64\x22\x5d')['\x67\x65\x74\x41\x74\x74\x72\x69\x62\x75\x74\x65']('\x63\x6f\x6e\x74\x65\x6e\x74');const iframe=window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72']('\x69\x66\x72\x61\x6d\x65');const src=iframe?iframe['\x67\x65\x74\x41\x74\x74\x72\x69\x62\x75\x74\x65']('\x73\x72\x63'):'';const url=new URL(src,'\x68\x74\x74\x70\x73\x3a\x2f\x2f\x65\x78\x61\x6d\x70\x6c\x65\x2e\x63\x6f\x6d');devToken=url['\x73\x65\x61\x72\x63\x68\x50\x61\x72\x61\x6d\x73']['\x67\x65\x74']('\x64\x65\x76\x54\x6f\x6b\x65\x6e');let cok=getCookieMap(window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x63\x6f\x6f\x6b\x69\x65']);mnt=cok['\x67\x65\x74']("\x6d\x65\x64\x69\x61\x2d\x75\x73\x65\x72\x2d\x74\x6f\x6b\x65\x6e");const xhr=new XMLHttpRequest();xhr['\x6f\x70\x65\x6e']("\x47\x45\x54","\x68\x74\x74\x70\x73\x3a\x2f\x2f\x61\x6d\x70\x2d\x61\x70\x69\x2e\x6d\x75\x73\x69\x63\x2e\x61\x70\x70\x6c\x65\x2e\x63\x6f\x6d\x2f\x76\x31\x2f\x63\x61\x74\x61\x6c\x6f\x67\x2f"+regionCode+"\x2f\x61\x6c\x62\x75\x6d\x73\x2f"+aid+"\x3f\x6c\x3d"+lang);xhr['\x73\x65\x74\x52\x65\x71\x75\x65\x73\x74\x48\x65\x61\x64\x65\x72']("\x61\x75\x74\x68\x6f\x72\x69\x7a\x61\x74\x69\x6f\x6e","\x42\x65\x61\x72\x65\x72 "+devToken);xhr['\x73\x65\x74\x52\x65\x71\x75\x65\x73\x74\x48\x65\x61\x64\x65\x72']("\x6d\x65\x64\x69\x61\x2d\x75\x73\x65\x72\x2d\x74\x6f\x6b\x65\x6e",mnt);xhr['\x6f\x6e\x6c\x6f\x61\x64']=async()=>{if(xhr['\x73\x74\x61\x74\x75\x73']===200){var ykvYkLfsC2=JSON['\x70\x61\x72\x73\x65'](xhr['\x72\x65\x73\x70\x6f\x6e\x73\x65\x54\x65\x78\x74']);r=extractSongDetails(ykvYkLfsC2['\x64\x61\x74\x61'][0]);await getAlbumDetail(r)}else{console['\x65\x72\x72\x6f\x72']("\x65\x72\x72\x6f\x72")}};xhr['\x73\x65\x6e\x64']()};async function fetchData(BseUhWc3){const headers=new Headers();headers['\x61\x70\x70\x65\x6e\x64']("\x61\x75\x74\x68\x6f\x72\x69\x7a\x61\x74\x69\x6f\x6e","\x42\x65\x61\x72\x65\x72 "+devToken);headers['\x61\x70\x70\x65\x6e\x64']("\x6d\x65\x64\x69\x61\x2d\x75\x73\x65\x72\x2d\x74\x6f\x6b\x65\x6e",mnt);let response=await fetch(BseUhWc3,{method:"\x47\x45\x54",headers:headers,});if(!response['\x6f\x6b']){throw new window["\x45\x72\x72\x6f\x72"]("\x48\x54\x54\x50 \x65\x72\x72\x6f\x72\x21 \x53\x74\x61\x74\x75\x73\x3a "+response['\x73\x74\x61\x74\x75\x73']);}return await response['\x6a\x73\x6f\x6e']()};async function getAlbumDetail(JBQld4){const maxConcurrency=1;let inProgress=[];for(let song of JBQld4){let u="\x68\x74\x74\x70\x73\x3a\x2f\x2f\x61\x6d\x70\x2d\x61\x70\x69\x2e\x6d\x75\x73\x69\x63\x2e\x61\x70\x70\x6c\x65\x2e\x63\x6f\x6d\x2f\x76\x31\x2f\x63\x61\x74\x61\x6c\x6f\x67\x2f"+regionCode+"\x2f\x73\x6f\x6e\x67\x73\x2f"+song['\x73\x6f\x6e\x67\x69\x64']+"\x2f\x6c\x79\x72\x69\x63\x73";var ItLSg5=song['\x73\x69\x6e\x67\x65\x72']+" \x2d "+song['\x73\x6f\x6e\x67\x6e\x61\x6d\x65']+"\x2e\x6c\x72\x63";inProgress['\x70\x75\x73\x68'](fetchData(u)['\x74\x68\x65\x6e']((r)=>{var svATts6=parse_ttml(extractTtml(r['\x64\x61\x74\x61'][0]));saveToFile(svATts6,ItLSg5)}));if(inProgress['\x6c\x65\x6e\x67\x74\x68']>=maxConcurrency){await Promise['\x61\x6c\x6c'](inProgress);inProgress=[]}}await Promise['\x61\x6c\x6c'](inProgress)};function extractTtml(rfsHVXmGU7){return rfsHVXmGU7['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']['\x74\x74\x6d\x6c']||'\x4e\x6f \x54\x54\x4d\x4c \x66\x6f\x75\x6e\x64'};function extractSongDetails(ENSk$8){if(!ENSk$8||!ENSk$8['\x72\x65\x6c\x61\x74\x69\x6f\x6e\x73\x68\x69\x70\x73']||!ENSk$8['\x72\x65\x6c\x61\x74\x69\x6f\x6e\x73\x68\x69\x70\x73']['\x74\x72\x61\x63\x6b\x73']||!window["\x41\x72\x72\x61\x79"]['\x69\x73\x41\x72\x72\x61\x79'](ENSk$8['\x72\x65\x6c\x61\x74\x69\x6f\x6e\x73\x68\x69\x70\x73']['\x74\x72\x61\x63\x6b\x73']['\x64\x61\x74\x61'])){console['\x65\x72\x72\x6f\x72']("\x49\x6e\x76\x61\x6c\x69\x64 \x4a\x53\x4f\x4e \x73\x74\x72\x75\x63\x74\x75\x72\x65");return[]}return ENSk$8['\x72\x65\x6c\x61\x74\x69\x6f\x6e\x73\x68\x69\x70\x73']['\x74\x72\x61\x63\x6b\x73']['\x64\x61\x74\x61']['\x6d\x61\x70'](track=>{return{songid:track['\x69\x64']||'\x55\x6e\x6b\x6e\x6f\x77\x6e',songname:track['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']&&track['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']['\x6e\x61\x6d\x65']?track['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']['\x6e\x61\x6d\x65']:'\x55\x6e\x6b\x6e\x6f\x77\x6e',singer:track['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']&&track['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']['\x61\x72\x74\x69\x73\x74\x4e\x61\x6d\x65']?track['\x61\x74\x74\x72\x69\x62\x75\x74\x65\x73']['\x61\x72\x74\x69\x73\x74\x4e\x61\x6d\x65']:'\x55\x6e\x6b\x6e\x6f\x77\x6e'}})};function parse_ttml(AJ9){const parser=new DOMParser();const xmlDoc=parser['\x70\x61\x72\x73\x65\x46\x72\x6f\x6d\x53\x74\x72\x69\x6e\x67'](AJ9,"\x74\x65\x78\x74\x2f\x78\x6d\x6c");const paragraphs=xmlDoc['\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x41\x6c\x6c']('\x70');const result=[];function convertTimeToSeconds(aow10){if(aow10['\x69\x6e\x63\x6c\x75\x64\x65\x73']('\x3a')){const[minutes,rest]=aow10['\x73\x70\x6c\x69\x74']('\x3a');const[seconds,milliseconds]=rest['\x73\x70\x6c\x69\x74']('\x2e');return window["\x70\x61\x72\x73\x65\x46\x6c\x6f\x61\x74"](minutes)*60+window["\x70\x61\x72\x73\x65\x46\x6c\x6f\x61\x74"](seconds)+(window["\x70\x61\x72\x73\x65\x46\x6c\x6f\x61\x74"](milliseconds)||0)/1000}else{return window["\x70\x61\x72\x73\x65\x46\x6c\x6f\x61\x74"](aow10)}}function formatTime(YkmlB11){const minutes=window["\x4d\x61\x74\x68"]['\x66\x6c\x6f\x6f\x72'](YkmlB11/60)['\x74\x6f\x53\x74\x72\x69\x6e\x67']()['\x70\x61\x64\x53\x74\x61\x72\x74'](2,'\x30');const secs=(YkmlB11%60)['\x74\x6f\x46\x69\x78\x65\x64'](3)['\x70\x61\x64\x53\x74\x61\x72\x74'](6,'\x30');return'\x5b'+minutes+'\x3a'+secs+'\x5d'}paragraphs['\x66\x6f\x72\x45\x61\x63\x68']((p,index)=>{const beginTime=p['\x67\x65\x74\x41\x74\x74\x72\x69\x62\x75\x74\x65']('\x62\x65\x67\x69\x6e');let isLastElement=index===paragraphs['\x6c\x65\x6e\x67\x74\x68']-1;let text=p['\x74\x65\x78\x74\x43\x6f\x6e\x74\x65\x6e\x74']['\x74\x72\x69\x6d']();let str="";if(beginTime!=null){const beginSeconds=convertTimeToSeconds(beginTime);const beginTimeFormatted=formatTime(beginSeconds);str=beginTimeFormatted+' '+text+(isLastElement?'':'\n')}else{str=text+(isLastElement?'':'\n')}result['\x70\x75\x73\x68'](str)});return result['\x6a\x6f\x69\x6e']('')};function getCookieMap(sgaTcNm_12){let cookiePattern=/^([^=]+)=([^;]*)/;let cookieArray=sgaTcNm_12['\x73\x70\x6c\x69\x74']("\x3b ");let cookieMap=new Map();for(let item of cookieArray){let resultArray=cookiePattern['\x65\x78\x65\x63'](item);if(resultArray){cookieMap['\x73\x65\x74'](decodeURIComponent(resultArray[1]['\x74\x72\x69\x6d']()),decodeURIComponent(resultArray[2]['\x74\x72\x69\x6d']()))}}return cookieMap};function saveToFile(AtniI13,JMdJBzQD14){const blob=new Blob([AtniI13],{type:'\x74\x65\x78\x74\x2f\x70\x6c\x61\x69\x6e'});const url=URL['\x63\x72\x65\x61\x74\x65\x4f\x62\x6a\x65\x63\x74\x55\x52\x4c'](blob);const a=window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x63\x72\x65\x61\x74\x65\x45\x6c\x65\x6d\x65\x6e\x74']('\x61');a['\x68\x72\x65\x66']=url;a['\x64\x6f\x77\x6e\x6c\x6f\x61\x64']=JMdJBzQD14;a['\x73\x74\x79\x6c\x65']['\x64\x69\x73\x70\x6c\x61\x79']='\x6e\x6f\x6e\x65';window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x62\x6f\x64\x79']['\x61\x70\x70\x65\x6e\x64\x43\x68\x69\x6c\x64'](a);a['\x63\x6c\x69\x63\x6b']();URL['\x72\x65\x76\x6f\x6b\x65\x4f\x62\x6a\x65\x63\x74\x55\x52\x4c'](url);window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x62\x6f\x64\x79']['\x72\x65\x6d\x6f\x76\x65\x43\x68\x69\x6c\x64'](a)};window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]['\x62\x6f\x64\x79']['\x61\x70\x70\x65\x6e\x64\x43\x68\x69\x6c\x64'](btn);
